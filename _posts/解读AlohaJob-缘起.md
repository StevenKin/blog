---
title: 解读AlohaJob-缘起
date: 2020-10-26 14:10:24
tags: 分布式调度，AlohaJob
---
## 前言
从这篇博客开始，我开始一个分布式任务调度框架[AlohaJob](https://github.com/StevenKin/AlohaJob)的解读。
## 序言
[AlohaJob](https://github.com/StevenKin/AlohaJob)，字面意思为`你好，任务`，`Aloha`是夏威夷语“你好”的意思，从名字可以看出，这是一个与任务有关的项目，主要做有关任务调度的事。关于这个项目，你可能有以下两个问题：
1. 市面上任务调度系统那么多，你为什么还要重复造轮子呢？
2. 这个任务调度系统有什么特别之处呢？
回答1：市面上的确有很多任务调度系统，比如之前我们公司用过的xxl-job，和当当开源的ElasticJob，还有quartz的集群版本，以及一众基于quartz的分布式任务调度，我基本上都研究过，不可否认的是，它们都是优秀的开源项目，但都有或多或少的问题：比如quartz虽然可以分布式部署，但强依赖数据库行锁，性能有隐患，最重要的是quartz基本是一个黑盒，没有在线运维的功能，出了问题就抓瞎。ElasticJob基于zookeeper重写了调度逻辑，并提供了任务分片功能，比quartz不知要好到哪里去了，但还是有其他的问题，首先基于zookeeper，当有海量任务时zookeeper会假死（不要问我怎么知道的，之前公司自研的分布式调度就是基于zookeeper)，第二是
ElasticJob很长一段时间没有维护了，有一堆bug。xxl-job是现在很火的一个任务调度框架，基本上所有要支持的特性有，但还是有两个问题：xxl-job不支持基于有向无环图（DAG）的任务编排，虽然xxl-job支持任务依赖，但不支持菱形依赖，我实验过，最后一个job会执行两次。xxl-job支持任务分片，但不支持动态分片，文档里的动态分片是根据执行器来动态分片，我说的动态分片是在job的执行过程中可编程的根据要处理的数据动态分片，这一点xxl-job是做不到的。这也是我的前东家放弃xxl-job的原因。动态分片也是[AlohaJob](https://github.com/StevenKin/AlohaJob)的一个重要特性。
回答2：这个分布式任务调度框架的特别之处有三点，动态分片，隔离调度和可扩展。
动态分片：
市面上现有的调度框架基本都支持任务分片，但都是静态分片和根据执行器动态扩容而进行分片。我认为这都不是真正的动态分片。真正的动态分片应是在job的处理过程中，根据环境，比如要处理的数据，在控制台传入的参数，可编程的生成新的分片，这才是`动态分片`，静态分片和根据执行器动态扩容而进行分片只是动态分片的一个特殊情况。
隔离调度：
市面上流行的调度系统比如xxl-job都是调度和执行分离的架构设计，将调度和执行分离开可以使他们之间的影响降到最低，比如执行器挂了调度器可以继续工作，随着业务的发展，任务调度的需求会越来越多，对调度器的要求也会更高，例如能够监控任务的执行进度，能够根据应用负载动态路由选择更健康的执行器去执行任务，这都需要将调度和执行分离。一般来说为实现调度的高可用调度器一般都多机部署，这带来一个问题，那就是重复调度，试想，两个调度器同时从数据库里select到一个将要触发的job，那么这个job可能就会重复触发执行。一般的解决方案是分布式锁，两个调度器获取一个分布式锁，拿到锁的才能select到job。因为要获取锁，肯定使调度器性能下降，调度器每一次select都需要获取锁。既然一个job只能被一个调度器所触发，那就让这个job始终由这个调度器负责调度不就行了，job提前分配好调度器，那大家都不要抢，和和气气的多好。现在有两个调度器s1,s2,4个job j1,j2,j3,j4,其中j1,j2属于group1，j3，j4属于group2，s1始终调度group1的job，s2始终调度group2的job，所有的job通过group进行隔离。一个group始终被一个调度器调度，这就是隔离调度。
可扩展：
调度框架对很多可以有多种实现的组件进行抽象，比如服务发现，延时器，触发策略等。框架给出默认实现，如果不符合要求，可以由用户自己来进行实现。只需要引入对应的jar包，在配置文件中配置好，就可以使用了，这里，借鉴了dubbo的扩展点的思想，基于此[AlohaJob](https://github.com/StevenKin/AlohaJob)十分灵活，高度可扩展。
## 依赖
基于最小依赖原则，[AlohaJob](https://github.com/StevenKin/AlohaJob)仅依赖
1. java 8及以上的版本
2. mysql
3. spring boot

当然你可以依赖任意多的组件，比如框架现在没有提供调度器的服务发现，你可以使用框架的扩展点机制实现服务发现接口，接入公司的服务发现平台，比如zookeeper，eureka等。
## 结尾
[AlohaJob](https://github.com/StevenKin/AlohaJob)现在正在开发，如果你有兴趣，欢迎star，fork，提issue，Thanks♪(･ω･)ﾉ